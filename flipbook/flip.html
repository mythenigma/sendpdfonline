<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta name="robots" content="noindex, nofollow">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaiPDF Flipbook Viewer</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    
    #flipbook {
      width: 90vw;
      height: 80vh;
      max-width: 1000px;
      max-height: 700px;
      margin: 0 auto;
    }
    
    /* æ‰‹æœºç«¯é€‚é… */
    @media (max-width: 768px) {
      #flipbook {
        width: 95vw;
        height: 70vh;
        min-width: 300px;
        min-height: 400px;
      }
      
      body {
        padding: 10px;
      }
    }
    img {
      image-rendering: auto;
      image-rendering: crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: pixelated;
    }
    
    .page {
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .page img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    
    /* StPageFlip é¡µé¢æ ·å¼ä¼˜åŒ– */
    .stf__item {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stf__item img {
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    /* åŠ è½½æç¤º */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #333;
      font-size: 18px;
      z-index: 1000;
      text-align: center;
    }
    
    /* æ§åˆ¶é¢æ¿ */
    .controls {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 2000;
      backdrop-filter: blur(10px);
    }
    
    .controls h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #333;
    }
    
    .folder-selector {
      margin-bottom: 10px;
    }
    
    .folder-selector label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #666;
    }
    
    .folder-selector select {
      width: 200px;
      padding: 8px 12px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    
    .folder-selector select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-reload {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-top: 5px;
    }
    
    .btn-reload:hover {
      background: #5a6fd8;
      transform: translateY(-1px);
    }
    
    .info-display {
      margin-top: 10px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
    }
    
    .config-note {
      margin-top: 5px;
      padding: 6px;
      background: #e7f3ff;
      border-left: 3px solid #007bff;
      border-radius: 3px;
      font-size: 11px;
      color: #0056b3;
    }
  </style>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
  <!-- æ§åˆ¶é¢æ¿ -->
  <div class="controls">
    <h3>ğŸ“‚ æ–‡ä»¶å¤¹é€‰æ‹©</h3>
    <div class="folder-selector">
      <label for="folderSelect">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹:</label>
      <select id="folderSelect" onchange="onFolderChange()">
        <option value="stflip">stflip (æ¨ªå‘/æ··åˆ)</option>
        <option value="portrait">portrait (çºµå‘)</option>
      </select>
    </div>
    <button class="btn-reload" onclick="reloadFlipbook()">ğŸ”„ é‡æ–°åŠ è½½</button>
    <div class="info-display" id="infoDisplay">
      å½“å‰: stflip æ–‡ä»¶å¤¹
    </div>
    <div class="config-note">
      ğŸ’¡ å›¾ç‰‡æ•°é‡éœ€æ‰‹åŠ¨é…ç½®<br>
      å¦‚éœ€æ·»åŠ æ–‡ä»¶å¤¹ï¼Œè¯·ä¿®æ”¹ä»£ç ä¸­çš„ folderConfig
    </div>
  </div>

  <div class="loading" id="loading">
    <div>åŠ è½½ç¿»é¡µä¹¦ä¸­...</div>
    <div style="font-size: 14px; margin-top: 10px;">è¯·ç¨å€™</div>
  </div>
  
  <div id="flipbook" style="display: none;"></div>

  <script src="./page-flip.browser.js"></script>
  <script>
    let currentPageFlip = null;
    let currentFolder = 'stflip';
    
    // æ–‡ä»¶å¤¹é…ç½® - æ‰‹åŠ¨æŒ‡å®šæ¯ä¸ªæ–‡ä»¶å¤¹çš„å›¾ç‰‡æ•°é‡
    const folderConfig = {
      'stflip': {
        count: 10,
        name: 'æ¨ªå‘/æ··åˆ',
        description: 'åŒ…å«ä¸åŒæ–¹å‘çš„å›¾ç‰‡'
      },
      'portrait': {
        count: 4,
        name: 'çºµå‘',
        description: 'ä¸»è¦ä¸ºçºµå‘å›¾ç‰‡'
      }
    };

    // è·å–å½“å‰é€‰æ‹©çš„æ–‡ä»¶å¤¹è·¯å¾„
    function getCurrentFolderPath() {
      const folderSelect = document.getElementById('folderSelect');
      currentFolder = folderSelect.value;
      return `./${currentFolder}/`;
    }

    // æ–‡ä»¶å¤¹é€‰æ‹©å˜æ›´äº‹ä»¶
    function onFolderChange() {
      const folderSelect = document.getElementById('folderSelect');
      const selectedFolder = folderSelect.value;
      console.log('é€‰æ‹©æ–‡ä»¶å¤¹:', selectedFolder);
      currentFolder = selectedFolder;
      updateInfoDisplay(currentFolder);
    }

    // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
    function updateInfoDisplay(folder, imageCount = 0, avgRatio = 0) {
      const info = document.getElementById('infoDisplay');
      if (!info) {
        console.error('âŒ æ‰¾ä¸åˆ° infoDisplay å…ƒç´ ');
        return;
      }
      
      const config = folderConfig[folder];
      if (!config) {
        console.error('âŒ æ‰¾ä¸åˆ°æ–‡ä»¶å¤¹é…ç½®:', folder);
        return;
      }
      
      const folderType = config.name;
      const expectedCount = config.count;
      
      info.innerHTML = `
        å½“å‰: ${folder} æ–‡ä»¶å¤¹ (${folderType})<br>
        é¢„æœŸå›¾ç‰‡: ${expectedCount} å¼ <br>
        ${imageCount > 0 ? `å®é™…åŠ è½½: ${imageCount} å¼ <br>` : ''}
        ${avgRatio > 0 ? `å¹³å‡å®½é«˜æ¯”: ${avgRatio.toFixed(2)}` : ''}
      `;
    }

    // é‡æ–°åŠ è½½ç¿»é¡µä¹¦
    function reloadFlipbook() {
      const folderSelect = document.getElementById('folderSelect');
      if (!folderSelect) {
        console.error('âŒ æ‰¾ä¸åˆ° folderSelect å…ƒç´ ');
        alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶å¤¹é€‰æ‹©å™¨ï¼');
        return;
      }
      
      const newFolder = folderSelect.value;
      
      console.log('ğŸ”„ é‡æ–°åŠ è½½ç¿»é¡µä¹¦...');
      console.log('å½“å‰é€‰æ‹©çš„æ–‡ä»¶å¤¹:', newFolder);
      console.log('folderConfigä¸­çš„é…ç½®:', folderConfig[newFolder]);
      
      if (!folderConfig[newFolder]) {
        console.error('âŒ æ–‡ä»¶å¤¹é…ç½®ä¸å­˜åœ¨:', newFolder);
        alert(`é”™è¯¯ï¼šæ–‡ä»¶å¤¹ "${newFolder}" çš„é…ç½®ä¸å­˜åœ¨ï¼`);
        return;
      }
      
      // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ 
      const loadingElement = document.getElementById('loading');
      const flipbookElement = document.getElementById('flipbook');
      
      if (!loadingElement) {
        console.error('âŒ æ‰¾ä¸åˆ° loading å…ƒç´ ');
        return;
      }
      
      if (!flipbookElement) {
        console.error('âŒ æ‰¾ä¸åˆ° flipbook å…ƒç´ ');
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      loadingElement.style.display = 'block';
      flipbookElement.style.display = 'none';
      
      // æ›´æ–°å½“å‰æ–‡ä»¶å¤¹
      currentFolder = newFolder;
      updateInfoDisplay(currentFolder);
      
      // ç®€å•ç²—æš´çš„æ–¹æ³•ï¼šåˆ·æ–°é¡µé¢
      console.log('ğŸ”„ å³å°†åˆ·æ–°é¡µé¢ä»¥åˆ‡æ¢æ–‡ä»¶å¤¹...');
      
      // ä¿å­˜é€‰æ‹©çš„æ–‡ä»¶å¤¹åˆ° localStorage
      localStorage.setItem('selectedFolder', newFolder);
      
      // åˆ·æ–°é¡µé¢
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }

    // æ£€æŸ¥StPageFlipåº“æ˜¯å¦åŠ è½½
    function checkLibrary() {
      if (typeof St === 'undefined' || typeof St.PageFlip === 'undefined') {
        console.error('âŒ StPageFlip åº“æœªæ­£ç¡®åŠ è½½ï¼');
        const loadingElement = document.getElementById('loading');
        if (loadingElement) {
          loadingElement.innerHTML = '<div style="color: #ff6b6b;">StPageFlip åº“åŠ è½½å¤±è´¥</div>';
        }
        return false;
      }
      return true;
    }

    const preloadImageSizes = async (paths) => {
      console.log(`å¼€å§‹é¢„åŠ è½½ ${currentFolder} æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡...`);
      const dimensions = await Promise.all(paths.map((src, index) => {
        return new Promise(resolve => {
          const img = new Image();
          img.onload = () => {
            const ratio = img.width / img.height;
            const type = ratio > 1 ? 'landscape' : 'portrait';
            console.log(`âœ… å›¾ç‰‡ ${index + 1} (${type}): ${img.width}x${img.height}, æ¯”ä¾‹: ${ratio.toFixed(2)}`);
            resolve({ width: img.width, height: img.height, src, ratio, type });
          };
          img.onerror = () => {
            console.error(`âŒ å›¾ç‰‡ ${index + 1} åŠ è½½å¤±è´¥: ${src}`);
            resolve({ width: 800, height: 600, src, ratio: 1.33, type: 'landscape' }); // é»˜è®¤å°ºå¯¸
          };
          img.src = src;
        });
      }));
      return dimensions;
    };

    // åˆå§‹åŒ–å‡½æ•°
    async function initFlipbook() {
      if (!checkLibrary()) {
        return;
      }

      try {
        console.log('ğŸ“ å½“å‰ä½¿ç”¨çš„æ–‡ä»¶å¤¹:', currentFolder);
        const folderPath = getCurrentFolderPath();
        const currentConfig = folderConfig[currentFolder];
        const totalPages = currentConfig.count;
        
        console.log(`ğŸ“ åŠ è½½æ–‡ä»¶å¤¹: ${currentFolder} (${currentConfig.name})`);
        console.log(`ğŸ“¸ é¢„æœŸå›¾ç‰‡æ•°é‡: ${totalPages}`);
        
        const imagePaths = Array.from({ length: totalPages }, (_, i) => `${folderPath}${i + 1}.jpg`);
        
        const sizes = await preloadImageSizes(imagePaths);
        
        // åˆ†æå›¾ç‰‡ç±»å‹
        const landscapeCount = sizes.filter(s => s.type === 'landscape').length;
        const portraitCount = sizes.filter(s => s.type === 'portrait').length;
        const avgRatio = sizes.reduce((sum, s) => sum + s.ratio, 0) / sizes.length;
        
        console.log(`ğŸ“Š å›¾ç‰‡åˆ†æç»“æœ:`);
        console.log(`   æ¨ªå‘å›¾ç‰‡: ${landscapeCount} å¼ `);
        console.log(`   çºµå‘å›¾ç‰‡: ${portraitCount} å¼ `);
        console.log(`   å¹³å‡å®½é«˜æ¯”: ${avgRatio.toFixed(2)}`);
        
        updateInfoDisplay(currentFolder, sizes.length, avgRatio);
        
        const screenHeight = window.innerHeight;
        const screenWidth = window.innerWidth;

        let fitWidth = screenWidth * 0.8; // ä½¿ç”¨80%çš„å±å¹•å®½åº¦
        let fitHeight = fitWidth / avgRatio;
        
        if (fitHeight > screenHeight * 0.8) {
          fitHeight = screenHeight * 0.8;
          fitWidth = fitHeight * avgRatio;
        }

        const forceSinglePage = true; // å¼ºåˆ¶æ‰€æœ‰é¡µé¢éƒ½å•é¡µå±•ç¤º
        console.log('å¼ºåˆ¶å•é¡µæ¨¡å¼:', forceSinglePage);

        // ç¡®ä¿ flipbook å®¹å™¨å¤„äºæ­£ç¡®çŠ¶æ€
        const flipbookContainer = document.getElementById('flipbook');
        if (!flipbookContainer) {
          console.error('âŒ æ‰¾ä¸åˆ° flipbook å®¹å™¨');
          document.getElementById('loading').innerHTML = '<div style="color: #ff6b6b;">æ‰¾ä¸åˆ°ç¿»é¡µä¹¦å®¹å™¨</div>';
          return;
        }
        
        // ç¡®ä¿å®¹å™¨æ˜¯ç©ºçš„å’Œå¯è§çš„
        flipbookContainer.innerHTML = '';
        flipbookContainer.style.display = 'block';

        console.log('ğŸš€ å¼€å§‹åˆ›å»º StPageFlip å®ä¾‹...');
        const pageFlip = new St.PageFlip(
          flipbookContainer,
          {
            width: Math.round(fitWidth),
            height: Math.round(fitHeight),
            size: 'stretch',
            minWidth: 315,
            maxWidth: 1200,
            minHeight: 400,
            maxHeight: 800,
            maxShadowOpacity: 0.5,
            showCover: false,
            mobileScrollSupport: true,
            useMouseEvents: true,
            drawShadow: true,
            usePortrait: true,
            swipeDistance: 50,
            flippingTime: 800,
            autoSize: true,
            startZIndex: 100
          }
        );
        
        console.log('âœ… StPageFlip å®ä¾‹åˆ›å»ºæˆåŠŸ');

        const pages = sizes.map((img, index) => {
          console.log(`å›¾ç‰‡ ${index + 1} (${img.type}): å®½åº¦=${img.width}, é«˜åº¦=${img.height}, æ¯”ä¾‹=${img.ratio.toFixed(2)}`);
          return [img.src];
        });

        const pageWrappers = pages.map((pair, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'page';
          
          // æ ¹æ®å›¾ç‰‡ç±»å‹è°ƒæ•´é¡µé¢æ ·å¼
          const imgType = sizes[index].type;
          const styleColor = imgType === 'landscape' ? '#fff3cd' : '#d1ecf1';
          wrapper.style.cssText = `background: ${styleColor}; padding: 10px; border-radius: 8px; border: 2px solid ${imgType === 'landscape' ? '#ffc107' : '#17a2b8'};`;
          
          pair.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.alt = `ç¬¬ ${index + 1} é¡µ (${imgType})`;
            img.style.cssText = 'width: 100%; height: 100%; object-fit: contain; border-radius: 4px;';
            wrapper.appendChild(img);
          });
          
          console.log(`åˆ›å»ºé¡µé¢ ${index + 1} (${imgType})ï¼ŒåŒ…å« ${pair.length} å¼ å›¾ç‰‡`);
          return wrapper;
        });

        // åŠ è½½é¡µé¢
        currentPageFlip = pageFlip;
        pageFlip.loadFromHTML(pageWrappers);
        
        // ç›‘å¬äº‹ä»¶
        pageFlip.on('init', () => {
          console.log('âœ… StPageFlip åˆå§‹åŒ–å®Œæˆ');
          document.getElementById('loading').style.display = 'none';
          document.getElementById('flipbook').style.display = 'block';
        });
        
        pageFlip.on('flip', (e) => {
          console.log(`ç¿»é¡µåˆ°ç¬¬ ${e.data + 1} é¡µ`);
        });
        
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
        const loadingElement = document.getElementById('loading');
        if (loadingElement) {
          loadingElement.innerHTML = `
            <div style="color: #ff6b6b; text-align: center;">
              <h3>åˆå§‹åŒ–å¤±è´¥</h3>
              <p>é”™è¯¯: ${error.message}</p>
              <p style="font-size: 12px; color: #666; margin-top: 10px;">
                è¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯
              </p>
            </div>
          `;
        }
      }
    }

    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
      
      // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ–‡ä»¶å¤¹é€‰æ‹©
      const savedFolder = localStorage.getItem('selectedFolder');
      if (savedFolder && folderConfig[savedFolder]) {
        console.log('ğŸ“‚ æ¢å¤ä¿å­˜çš„æ–‡ä»¶å¤¹é€‰æ‹©:', savedFolder);
        currentFolder = savedFolder;
        const folderSelect = document.getElementById('folderSelect');
        if (folderSelect) {
          folderSelect.value = savedFolder;
        }
        // æ¸…é™¤ä¿å­˜çš„é€‰æ‹©
        localStorage.removeItem('selectedFolder');
      }
      
      // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
      const folderSelect = document.getElementById('folderSelect');
      const flipbook = document.getElementById('flipbook');
      const loading = document.getElementById('loading');
      
      if (!folderSelect) {
        console.error('âŒ æ‰¾ä¸åˆ° folderSelect å…ƒç´ ');
        return;
      }
      if (!flipbook) {
        console.error('âŒ æ‰¾ä¸åˆ° flipbook å…ƒç´ ');
        return;
      }
      if (!loading) {
        console.error('âŒ æ‰¾ä¸åˆ° loading å…ƒç´ ');
        return;
      }
      
      console.log('âœ… æ‰€æœ‰å¿…è¦å…ƒç´ éƒ½å­˜åœ¨');
      
      // åˆå§‹åŒ–æ˜¾ç¤ºä¿¡æ¯
      updateInfoDisplay(currentFolder);
      
      // å¯åŠ¨ç¿»é¡µä¹¦
      initFlipbook();
    });
  </script>
</body>
</html>
